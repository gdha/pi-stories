<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <link rel="shortcut icon" href="../img/favicon.ico" />
    <title>Raspberry Pi 4 Installation of Longhorn - Raspberry PI k3s stories</title>
    <link rel="stylesheet" href="../css/theme.css" />
    <link rel="stylesheet" href="../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/styles/github.min.css" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "Raspberry Pi 4 Installation of Longhorn";
        var mkdocs_page_input_path = "pi-stories9.md";
        var mkdocs_page_url = null;
      </script>
    
    <script src="../js/jquery-3.6.0.min.js" defer></script>
    <!--[if lt IE 9]>
      <script src="../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/highlight.min.js"></script>
      <script>hljs.initHighlightingOnLoad();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href=".." class="icon icon-home"> Raspberry PI k3s stories
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="..">WELCOME</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">PI4 STORIES</span></p>
              <ul class="current">
                  <li class="toctree-l1"><a class="reference internal" href="../pi-stories1/">Raspberry Pi 4 Basic OS Configuration</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../pi-stories2/">Raspberry Pi 4 Prepare for kubernetes</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../pi-stories3/">Raspberry Pi 4 Installing k3s software</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../pi-stories4/">Raspberry Pi 4 Install awesome kubectl aliases</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../pi-stories5/">Raspberry Pi 4 Installing cert-manager on our cluster</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../pi-stories6/">Raspberry Pi 4 Upgrading k3s software on your cluster</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../pi-stories7/">Raspberry Pi 4 YAML everywhere -what about correctness?</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../pi-stories8/">Raspberry Pi 4 Keep your Operating System updated</a>
                  </li>
                  <li class="toctree-l1 current"><a class="reference internal current" href="./">Raspberry Pi 4 Installation of Longhorn</a>
    <ul class="current">
    <li class="toctree-l2"><a class="reference internal" href="#raspberry_pi_4_cluster_series_-_installation_of_longhorn">Raspberry Pi 4 cluster Series - Installation of Longhorn</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#prepare_our_external_usb_block_devices">Prepare our external USB block devices</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#using_helm_to_perform_the_installation">Using helm to perform the installation</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#prepare_the_longhorn-ingress_required_for_ui">Prepare the longhorn-ingress (required for UI)</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#use_the_longhorn_ui">Use the longhorn UI</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#references">References</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#edit_history">Edit history</a>
    </li>
        </ul>
    </li>
    </ul>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../pi-stories10/">Raspberry Pi 4 Issues after upgrading k3s</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../pi-stories11/">Raspberry Pi 4 Replacing internal traefik with Metallb</a>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="..">Raspberry PI k3s stories</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href=".." class="icon icon-home" alt="Docs"></a> &raquo;</li>
          <li>PI4 STORIES &raquo;</li>
      <li>Raspberry Pi 4 Installation of Longhorn</li>
    <li class="wy-breadcrumbs-aside">
          <a href="https://github.com/gdha/pi-stories/edit/master/docs/pi-stories9.md">Edit on gdha/pi-stories</a>
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="pi4_stories">PI4 Stories<a class="headerlink" href="#pi4_stories" title="Permanent link">&para;</a></h1>
<h2 id="raspberry_pi_4_cluster_series_-_installation_of_longhorn">Raspberry Pi 4 cluster Series - Installation of Longhorn<a class="headerlink" href="#raspberry_pi_4_cluster_series_-_installation_of_longhorn" title="Permanent link">&para;</a></h2>
<h3 id="prepare_our_external_usb_block_devices">Prepare our external USB block devices<a class="headerlink" href="#prepare_our_external_usb_block_devices" title="Permanent link">&para;</a></h3>
<p>On all our pi systems we added an USB block device of the same size and we are sure that they all put in the same USB port so that we are sure the all have the same block device name, e.g. /dev/sda</p>
<p>We create an <a href="https://github.com/gdha/pi4-longhorn/blob/main/prepare-usb-disk/readme.md">ansible playbook to prepare the USB block devices</a> and have it mounted on <code>/app/longhorn</code> on each node. E.g.</p>
<pre><code class="language-bash">$ df /app/longhorn/
Filesystem     1K-blocks  Used Available Use% Mounted on
/dev/sda1      117715864 61472 111631688   1% /app/longhorn
</code></pre>
<h3 id="using_helm_to_perform_the_installation">Using helm to perform the installation<a class="headerlink" href="#using_helm_to_perform_the_installation" title="Permanent link">&para;</a></h3>
<p>If we want to use <code>helm</code> to performt the installation of longhorn we first need to install it as it isn't standard avaibale on these systems. Getting <code>helm</code> from URL <a href="https://helm.sh/docs/intro/install/">https://helm.sh/docs/intro/install/</a>.</p>
<pre><code class="language-bash">$ curl -fsSL -o get_helm.sh https://raw.githubusercontent.com/helm/helm/master/scripts/get-helm-3
$ chmod 700 get_helm.sh
$ ./get_helm.sh 
Helm v3.11.0 is available. Changing from version v3.7.1.
Downloading https://get.helm.sh/helm-v3.11.0-linux-arm64.tar.gz
Verifying checksum... Done.
Preparing to install helm into /usr/local/bin
helm installed into /usr/local/bin/helm
</code></pre>
<p>Alright, now we have the <code>helm</code> executable available on our local system (e.g. node n1). We can now download the helm longhorn chart repository:</p>
<pre><code class="language-bash">$ helm repo add longhorn https://charts.longhorn.io
&quot;longhorn&quot; has been added to your repositories

$ helm repo update
Hang tight while we grab the latest from your chart repositories...
...Successfully got an update from the &quot;longhorn&quot; chart repository
Update Complete. ⎈Happy Helming!⎈
</code></pre>
<p>We need to be careful when we run the helm installer as we only want longhorn to use the USB block devices mounted at <code>/app/longhorn</code> and it should not be using the default location <code>/var/lib/longhorn</code> (as this might fill up the root partition).
Information on how we can actually do this can be found at <a href="https://longhorn.io/docs/1.1.0/advanced-resources/default-disk-and-node-config/">"Adding Node Tags to New Nodes"</a>:</p>
<pre><code class="language-bash">$ helm install longhorn longhorn/longhorn --namespace longhorn-system  
  --set defaultSettings.defaultDataPath=&quot;/app/longhorn/&quot; --create-namespace
NAME: longhorn
LAST DEPLOYED: Tue Jan 24 14:38:41 2023
NAMESPACE: longhorn-system
STATUS: deployed
REVISION: 1
TEST SUITE: None
NOTES:
Longhorn is now installed on the cluster!

Please wait a few minutes for other Longhorn components such as CSI deployments, Engine Images, and Instance Managers to be initialized.

Visit our documentation at https://longhorn.io/docs/
</code></pre>
<h3 id="prepare_the_longhorn-ingress_required_for_ui">Prepare the longhorn-ingress (required for UI)<a class="headerlink" href="#prepare_the_longhorn-ingress_required_for_ui" title="Permanent link">&para;</a></h3>
<p>In-depth information about accessing the longhorn UI can be found at <a href="https://longhorn.io/docs/1.1.0/deploy/accessing-the-ui/longhorn-ingress/">longhorn-ingress</a>.</p>
<p>In short this is the procedure we followed:</p>
<pre><code class="language-bash">$ USER=gdha; PASSWORD=*******; echo &quot;${USER}:$(openssl passwd -stdin -apr1 &lt;&lt;&lt; ${PASSWORD})&quot; &gt;&gt; auth


$ cat auth 
gdha:$apr1$XXXXXXXXXXXXXXXXXXXXXXXX

$ kubectl -n longhorn-system create secret generic basic-auth --from-file=auth
secret/basic-auth created

$ kubectl -n longhorn-system get secret basic-auth -o yaml
apiVersion: v1
data:
  auth: Z2RoYTokYXByMSRSTW11bU5oRSQyd3ZCMzNFM0hyLjY4aGZvL2xkVGsuCg==
kind: Secret
metadata:
  creationTimestamp: &quot;2023-01-24T13:40:16Z&quot;
  name: basic-auth
  namespace: longhorn-system
  resourceVersion: &quot;13336&quot;
  uid: eeb2bd1f-9cae-4460-916d-b26c7eb97b7e
type: Opaque
</code></pre>
<p>Then we paste the following set of yaml command lines into kubectl to create the longhorn-ingress:</p>
<pre><code class="language-bash">$ cat longhorn-ingress.yaml
apiVersion: v1
items:
- apiVersion: networking.k8s.io/v1
  kind: Ingress
  metadata:
    annotations:
      nginx.ingress.kubernetes.io/auth-realm: 'Authentication Required '
      nginx.ingress.kubernetes.io/auth-secret: basic-auth
      nginx.ingress.kubernetes.io/auth-type: basic
      nginx.ingress.kubernetes.io/proxy-body-size: 10000m
      nginx.ingress.kubernetes.io/ssl-redirect: &quot;false&quot;
    creationTimestamp: &quot;2022-02-01T11:41:47Z&quot;
    generation: 4
    name: longhorn-ingress
    namespace: longhorn-system
    resourceVersion: &quot;3312028&quot;
    uid: bb838795-97d8-44e7-a3f1-4f74dd0854ee
  spec:
    rules:
    - http:
        paths:
        - backend:
            service:
              name: longhorn-frontend
              port:
                number: 80
          path: /
          pathType: ImplementationSpecific
  status:
    loadBalancer: {}
kind: List
metadata:
  resourceVersion: &quot;&quot;


$ kubectl create -f longhorn-ingress.yaml

$ kubectl describe ingress -n longhorn-system
Name:             longhorn-ingress
Labels:           &lt;none&gt;
Namespace:        longhorn-system
Address:          
Ingress Class:    traefik
Default backend:  &lt;default&gt;
Rules:
  Host        Path  Backends
  ----        ----  --------
  *           
              /   longhorn-frontend:80 (10.42.3.5:8000,10.42.4.6:8000)
Annotations:  nginx.ingress.kubernetes.io/auth-realm: Authentication Required 
              nginx.ingress.kubernetes.io/auth-secret: basic-auth
              nginx.ingress.kubernetes.io/auth-type: basic
              nginx.ingress.kubernetes.io/proxy-body-size: 10000m
              nginx.ingress.kubernetes.io/ssl-redirect: false
Events:       &lt;none&gt;
</code></pre>
<h3 id="use_the_longhorn_ui">Use the longhorn UI<a class="headerlink" href="#use_the_longhorn_ui" title="Permanent link">&para;</a></h3>
<p>As we have setup metallb with traefik [5] the longhorn-ingress is running is now available at IP address 192.168.0.230 and to test the connectivity we can use <code>curl</code>:</p>
<pre><code class="language-bash">$ curl -v 192.168.0.230:80
*   Trying 192.168.0.230:80...
* TCP_NODELAY set
* Connected to 192.168.0.230 (192.168.0.230) port 80 (#0)
&gt; GET / HTTP/1.1
&gt; Host: 192.168.0.230
&gt; User-Agent: curl/7.68.0
&gt; Accept: */*
&gt; 
* Mark bundle as not supporting multiuse
&lt; HTTP/1.1 200 OK
&lt; Cache-Control: max-age=0
&lt; Content-Type: text/html
&lt; Date: Tue, 24 Jan 2023 16:11:19 GMT
&lt; Etag: W/&quot;63adbe68-401&quot;
&lt; Last-Modified: Thu, 29 Dec 2022 16:20:56 GMT
&lt; Server: nginx/1.21.5
&lt; Vary: Accept-Encoding
&lt; Transfer-Encoding: chunked
&lt; 
&lt;!DOCTYPE html&gt;
&lt;html lang=&quot;en&quot;&gt;

&lt;head&gt;
  &lt;meta charset=&quot;UTF-8&quot;&gt;
  &lt;meta name=&quot;viewport&quot; content=&quot;width=device-width, initial-scale=1.0&quot;&gt;
  &lt;meta http-equiv=&quot;X-UA-Compatible&quot; content=&quot;IE=edge&quot;&gt;
  &lt;!--[if lte IE 10]&gt;
      &lt;script
        src=&quot;https://as.alipayobjects.com/g/component/??console-polyfill/0.2.2/index.js,media-match/2.0.2/media.match.min.js&quot;&gt;&lt;/script&gt;
  &lt;![endif]--&gt;
  &lt;style&gt;
    ::-webkit-scrollbar {
      width: 10px; 
      height: 1px;
    }

    ::-webkit-scrollbar-thumb {
      border-radius: 10px;
      -webkit-box-shadow: inset 0 0 5px rgba(0,0,0,0.1);
      background: #535353;
    }
  &lt;/style&gt;
&lt;link href=&quot;./styles.css?e0c09a3f2aae9c069d0c&quot; rel=&quot;stylesheet&quot;&gt;&lt;/head&gt;

&lt;body&gt;
  &lt;div id=&quot;root&quot;&gt;&lt;/div&gt;
&lt;script type=&quot;text/javascript&quot; src=&quot;./runtime~main.6d7bda24.js?e0c09a3f2aae9c069d0c&quot;&gt;&lt;/script&gt;&lt;script type=&quot;text/javascript&quot; src=&quot;./styles.985bf912.async.js?e0c09a3f2aae9c069d0c&quot;&gt;&lt;/script&gt;&lt;script type=&quot;text/javascript&quot; src=&quot;./main.c5723e73.async.js?e0c09a3f2aae9c069d0c&quot;&gt;&lt;/script&gt;&lt;/body&gt;

&lt;/html&gt;
* Connection #0 to host 192.168.0.230 left intact
</code></pre>
<p>However, we a browser pointing to <code>http://192.168.0.230/#/dashboard</code> we get a better overview:</p>
<p><img alt="" src="../img/longhorn-dashboard.png" /></p>
<p>Or, when selecting the node tab:</p>
<p><img alt="" src="../img/longhorn-nodes-overview.png" /></p>
<p>And, the details of one node:</p>
<p><img alt="" src="../img/longhorn-1node-details.png" /></p>
<h2 id="references">References<a class="headerlink" href="#references" title="Permanent link">&para;</a></h2>
<p>[1] <a href="https://github.com/gdha/pi4-longhorn/blob/main/prepare-usb-disk/readme.md">Ansible playbook to prepare USB devices</a></p>
<p>[2] <a href="https://longhorn.io/">Longhorn</a></p>
<p>[3] <a href="https://longhorn.io/docs/1.1.0/advanced-resources/default-disk-and-node-config/">Adding Node Tags to New Nodes</a></p>
<p>[4] <a href="https://longhorn.io/docs/1.1.0/deploy/accessing-the-ui/longhorn-ingress/">Accessing Loghorn through UI</a></p>
<p>[5] <a href="https://gdha.github.io/pi-stories/pi-stories11/">Replacing internal traefik with Metallb</a></p>
<h3 id="edit_history">Edit history<a class="headerlink" href="#edit_history" title="Permanent link">&para;</a></h3>
<ul>
<li>update for longhorn version 2.4.0 (24/Jan/2023)</li>
</ul>
              
            </div>
          </div><footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="Footer Navigation">
        <a href="../pi-stories8/" class="btn btn-neutral float-left" title="Raspberry Pi 4 Keep your Operating System updated"><span class="icon icon-circle-arrow-left"></span> Previous</a>
        <a href="../pi-stories10/" class="btn btn-neutral float-right" title="Raspberry Pi 4 Issues after upgrading k3s">Next <span class="icon icon-circle-arrow-right"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
      <p>Copyright 2023 - CC0 1.0 Universal</p>
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
    
      <span><a href="../pi-stories8/" style="color: #fcfcfc">&laquo; Previous</a></span>
    
    
      <span><a href="../pi-stories10/" style="color: #fcfcfc">Next &raquo;</a></span>
    
  </span>
</div>
    <script>var base_url = '..';</script>
    <script src="../js/theme_extra.js" defer></script>
    <script src="../js/theme.js" defer></script>
      <script src="../search/main.js" defer></script>
    <script defer>
        window.onload = function () {
            SphinxRtdTheme.Navigation.enable(true);
        };
    </script>

</body>
</html>
