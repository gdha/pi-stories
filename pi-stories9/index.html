<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  
  
  <link rel="shortcut icon" href="../img/favicon.ico">
  <title>Raspberry Pi 4 Installation of Longhorn - Raspberry PI k3s stories</title>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700" />

  <link rel="stylesheet" href="../css/theme.css" />
  <link rel="stylesheet" href="../css/theme_extra.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/styles/github.min.css" />
  
  <script>
    // Current page data
    var mkdocs_page_name = "Raspberry Pi 4 Installation of Longhorn";
    var mkdocs_page_input_path = "pi-stories9.md";
    var mkdocs_page_url = null;
  </script>
  
  <script src="../js/jquery-2.1.1.min.js" defer></script>
  <script src="../js/modernizr-2.8.3.min.js" defer></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/highlight.min.js"></script>
  <script>hljs.initHighlightingOnLoad();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
        <a href=".." class="icon icon-home"> Raspberry PI k3s stories</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="..">WELCOME</a>
                    </li>
                </ul>
                <p class="caption"><span class="caption-text">PI4 STORIES</span></p>
                <ul class="current">
                    <li class="toctree-l1"><a class="reference internal" href="../pi-stories1/">Raspberry Pi 4 Basic OS Configuration</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../pi-stories2/">Raspberry Pi 4 Prepare for kubernetes</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../pi-stories3/">Raspberry Pi 4 Installing k3s software</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../pi-stories4/">Raspberry Pi 4 Install awesome kubectl aliases</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../pi-stories5/">Raspberry Pi 4 Installing cert-manager on our cluster</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../pi-stories6/">Raspberry Pi 4 Upgrading k3s software on your cluster</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../pi-stories7/">Raspberry Pi 4 YAML everywhere -what about correctness?</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../pi-stories8/">Raspberry Pi 4 Keep your Operating System updated</a>
                    </li>
                    <li class="toctree-l1 current"><a class="reference internal current" href="./">Raspberry Pi 4 Installation of Longhorn</a>
    <ul class="current">
    <li class="toctree-l2"><a class="reference internal" href="#raspberry_pi_4_cluster_series_-_installation_of_longhorn">Raspberry Pi 4 cluster Series - Installation of Longhorn</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#prepare_our_external_usb_block_devices">Prepare our external USB block devices</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#using_helm_to_perform_the_installation">Using helm to perform the installation</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#prepare_the_longhorn-ingress_required_for_ui">Prepare the longhorn-ingress (required for UI)</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#use_the_longhorn_ui">Use the longhorn UI</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#references">References</a>
    </li>
    </ul>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../pi-stories10/">Raspberry Pi 4 Issues after upgrading k3s</a>
                    </li>
                </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="..">Raspberry PI k3s stories</a>
      </nav>

      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="..">Docs</a> &raquo;</li>
    
      
        
          <li>PI4 STORIES &raquo;</li>
        
      
    
    <li>Raspberry Pi 4 Installation of Longhorn</li>
    <li class="wy-breadcrumbs-aside">
      
        <a href="https://github.com/gdha/pi-stories/edit/master/docs/pi-stories9.md"> Edit on gdha/pi-stories</a>
      
    </li>
  </ul>
  
  <hr/>
</div>

          <div role="main">
            <div class="section">
              
                <h1 id="pi4_stories">PI4 Stories<a class="headerlink" href="#pi4_stories" title="Permanent link">&para;</a></h1>
<h2 id="raspberry_pi_4_cluster_series_-_installation_of_longhorn">Raspberry Pi 4 cluster Series - Installation of Longhorn<a class="headerlink" href="#raspberry_pi_4_cluster_series_-_installation_of_longhorn" title="Permanent link">&para;</a></h2>
<h3 id="prepare_our_external_usb_block_devices">Prepare our external USB block devices<a class="headerlink" href="#prepare_our_external_usb_block_devices" title="Permanent link">&para;</a></h3>
<p>On all our pi systems we added an USB block device of the same size and we are sure that they all put in the same USB port so that we are sure the all have the same block device name, e.g. /dev/sda</p>
<p>We create an <a href="https://github.com/gdha/pi4-longhorn/blob/main/prepare-usb-disk/readme.md">ansible playbook to prepare the USB block devices</a> and have it mounted on <code>/app/longhorn</code> on each node. E.g.</p>
<pre><code class="language-bash">$ df /app/longhorn/
Filesystem     1K-blocks  Used Available Use% Mounted on
/dev/sda1      117715864 61472 111631688   1% /app/longhorn
</code></pre>
<h3 id="using_helm_to_perform_the_installation">Using helm to perform the installation<a class="headerlink" href="#using_helm_to_perform_the_installation" title="Permanent link">&para;</a></h3>
<p>If we want to use <code>helm</code> to performt the installation of longhorn we first need to install it as it isn't standard avaibale on these systems. Getting <code>helm</code> from URL <a href="https://helm.sh/docs/intro/install/">https://helm.sh/docs/intro/install/</a>.</p>
<pre><code class="language-bash">$ curl -fsSL -o get_helm.sh https://raw.githubusercontent.com/helm/helm/master/scripts/get-helm-3
$ chmod 700 get_helm.sh
$ ./get_helm.sh 
Downloading https://get.helm.sh/helm-v3.5.3-linux-arm64.tar.gz
Verifying checksum... Done.
Preparing to install helm into /usr/local/bin
helm installed into /usr/local/bin/helm
</code></pre>
<p>Alright, now we have the <code>helm</code> executable available on our local system (e.g.node n1). We can now download the helm longhorn chart repository:</p>
<pre><code class="language-bash">$ helm repo add longhorn https://charts.longhorn.io
&quot;longhorn&quot; has been added to your repositories

$ helm repo update
Hang tight while we grab the latest from your chart repositories...
...Successfully got an update from the &quot;longhorn&quot; chart repository
Update Complete. ⎈Happy Helming!⎈
</code></pre>
<p>We need to be careful when we run the helm installer as we only want longhorn to use the USB block devices mounted at <code>/app/longhorn</code> and it should not be using the default location <code>/var/lib/longhorn</code> (as this might fill up the root partition).
Information on how we can actually do this can be found at <a href="https://longhorn.io/docs/1.1.0/advanced-resources/default-disk-and-node-config/">"Adding Node Tags to New Nodes"</a>:</p>
<pre><code class="language-bash">$ helm install longhorn longhorn/longhorn --namespace longhorn-system \
  --set defaultSettings.defaultDataPath=&quot;/app/longhorn/&quot;
NAME: longhorn
LAST DEPLOYED: Wed Apr 14 09:23:52 2021
NAMESPACE: longhorn-system
STATUS: deployed
REVISION: 1
TEST SUITE: None
NOTES:
Longhorn is now installed on the cluster!

Please wait a few minutes for other Longhorn components such as CSI deployments, Engine Images, and Instance Managers to be initialized.

Visit our documentation at https://longhorn.io/docs/
</code></pre>
<h3 id="prepare_the_longhorn-ingress_required_for_ui">Prepare the longhorn-ingress (required for UI)<a class="headerlink" href="#prepare_the_longhorn-ingress_required_for_ui" title="Permanent link">&para;</a></h3>
<p>In-depth information about accessing the longhorn UI can be found at <a href="https://longhorn.io/docs/1.1.0/deploy/accessing-the-ui/longhorn-ingress/">longhorn-ingress</a>.</p>
<p>In short this is the procedure we followed:</p>
<pre><code class="language-bash">$ USER=gdha; PASSWORD=*******; echo &quot;${USER}:$(openssl passwd -stdin -apr1 &lt;&lt;&lt; ${PASSWORD})&quot; &gt;&gt; auth


$ cat auth 
gdha:$apr1$XXXXXXXXXXXXXXXXXXXXXXXX

$ kubectl -n longhorn-system create secret generic basic-auth --from-file=auth
secret/basic-auth created

$ kubectl -n longhorn-system get secret basic-auth -o yaml
apiVersion: v1
data:
  auth: Z2RoYTokYXByMSRLTU1hQWpiSiROVENtRWI2Qm05dDdvSmJXV1RlWVcuCg==
kind: Secret
metadata:
  creationTimestamp: &quot;2021-04-09T15:38:05Z&quot;
  managedFields:
  - apiVersion: v1
    fieldsType: FieldsV1
    fieldsV1:
      f:data:
        .: {}
        f:auth: {}
      f:type: {}
    manager: kubectl-create
    operation: Update
    time: &quot;2021-04-09T15:38:05Z&quot;
  name: basic-auth
  namespace: longhorn-system
  resourceVersion: &quot;763254&quot;
  uid: 0a88e170-071d-4813-934f-9dec352be01d
type: Opaque
</code></pre>
<p>Then we paste the following set of yaml command lines into kubectl to create the longhorn-ingress:</p>
<pre><code class="language-bash">$ echo &quot;
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: longhorn-ingress
  namespace: longhorn-system
  annotations:
    # type of authentication
    nginx.ingress.kubernetes.io/auth-type: basic
    # prevent the controller from redirecting (308) to HTTPS
    nginx.ingress.kubernetes.io/ssl-redirect: 'false'
    # name of the secret that contains the user/password definitions
    nginx.ingress.kubernetes.io/auth-secret: basic-auth
    # message to display with an appropriate context why the authentication is required
    nginx.ingress.kubernetes.io/auth-realm: 'Authentication Required '
spec:
  rules:
  - http:
      paths:
      - path: /
        backend:
          serviceName: longhorn-frontend
          servicePort: 80
&quot; | kubectl -n longhorn-system create -f -
ingress.networking.k8s.io/longhorn-ingress created

$ kubectl -n longhorn-system get ingress
NAME               CLASS    HOSTS   ADDRESS         PORTS   AGE
longhorn-ingress   &lt;none&gt;   *       192.168.0.201   80      11s
</code></pre>
<h3 id="use_the_longhorn_ui">Use the longhorn UI<a class="headerlink" href="#use_the_longhorn_ui" title="Permanent link">&para;</a></h3>
<p>In previous command we saw that the IP address where the longhorn-ingress is running is in our case 192.168.0.201 and to test the connectivity we can use <code>curl</code>:</p>
<pre><code class="language-bash">$ curl -v http://192.168.0.201/
*   Trying 192.168.0.201:80...
* TCP_NODELAY set
* Connected to 192.168.0.201 (192.168.0.201) port 80 (#0)
&gt; GET / HTTP/1.1
&gt; Host: 192.168.0.201
&gt; User-Agent: curl/7.68.0
&gt; Accept: */*
...
</code></pre>
<p>However, we a browser pointing to <code>http://192.168.0.201/#/dashboard</code> we get a better overview:</p>
<p><img alt="" src="../img/longhorn-dashboard.png" /></p>
<p>Or, when selecting the node tab:</p>
<p><img alt="" src="../img/longhorn-nodes-overview.png" /></p>
<p>And, the details of one node:</p>
<p><img alt="" src="../img/longhorn-1node-details.png" /></p>
<h2 id="references">References<a class="headerlink" href="#references" title="Permanent link">&para;</a></h2>
<p>[1] <a href="https://github.com/gdha/pi4-longhorn/blob/main/prepare-usb-disk/readme.md">Ansible playbook to prepare USB devices</a></p>
<p>[2] <a href="https://longhorn.io/">Longhorn</a></p>
<p>[3] <a href="https://longhorn.io/docs/1.1.0/advanced-resources/default-disk-and-node-config/">Adding Node Tags to New Nodes</a></p>
<p>[4] <a href="https://longhorn.io/docs/1.1.0/deploy/accessing-the-ui/longhorn-ingress/">Accessing Loghorn through UI</a></p>
              
            </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../pi-stories10/" class="btn btn-neutral float-right" title="Raspberry Pi 4 Issues after upgrading k3s">Next <span class="icon icon-circle-arrow-right"></span></a>
      
      
        <a href="../pi-stories8/" class="btn btn-neutral" title="Raspberry Pi 4 Keep your Operating System updated"><span class="icon icon-circle-arrow-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
      <p>Copyright 2021 - CC0 1.0 Universal</p>
    
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
      
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
    
      <span><a href="../pi-stories8/" style="color: #fcfcfc">&laquo; Previous</a></span>
    
    
      <span><a href="../pi-stories10/" style="color: #fcfcfc">Next &raquo;</a></span>
    
  </span>
</div>
    <script>var base_url = '..';</script>
    <script src="../js/theme_extra.js" defer></script>
    <script src="../js/theme.js" defer></script>
      <script src="../search/main.js" defer></script>
    <script defer>
        window.onload = function () {
            SphinxRtdTheme.Navigation.enable(true);
        };
    </script>

</body>
</html>
